import"../chunks/Pk1FvCws.js";import{S as t}from"../chunks/CVw90xmA.js";import{D as e,C as i,a as s,b as o,c as n,H as a}from"../chunks/CAmFpRSf.js";import{U as r,D as c}from"../chunks/B3DQGssQ.js";import{C as h,a as l}from"../chunks/BhAH5UWs.js";import{O as g}from"../chunks/BGvEKeUN.js";import"../../static/js/pouchdb-8.0.1-supersimplehighlighter.min.js";angular.module("app",["controller","customFilters"]),h.addListeners("__on_storage_changed"),angular.module("controller",[]).controller("popupController",["$scope",async function(h){class p{static#t=500;#e=null;get db(){return this.#e||(this.#e=new e),this.#e}constructor(e){this.scope=e,this.styleSheetManager=new t(document),this.scope.sharedHighlightClassName=this.styleSheetManager.sharedHighlightClassName,this.scope.manifest=chrome.runtime.getManifest(),this.scope.commands={},this.scope.search={},this.scope.filters={group:t=>{const e=this.scope.search.text&&this.scope.search.text.toLowerCase();return t.docs.some((t=>!e||"string"==typeof t.text&&-1!=t.text.toLowerCase().indexOf(e)))},text:t=>{const e=this.scope.search.text&&this.scope.search.text.toLowerCase();return!e||"string"==typeof t.text&&-1!=t.text.toLowerCase().indexOf(e)}},this.scope.helpUrl=r.createExtensionAssetURL(chrome.i18n.getMessage("help_pathname",["chrome"]));for(const t of[this.onMouseEnterHighlight,this.onMouseLeaveHighlight,this.onClickHighlightText,this.onClickTrimHighlight,this.onClickExpandHighlight,this.onClickRemoveHighlight,this.onClickCopyHighlight,this.onClickSelectHighlight,this.onClickSpeakHighlight,this.onClickDefineHighlight,this.onClickUndoLastHighlight,this.onClickOpenOptionsPage,this.onClickOpenOverview,this.onClickSaveOverview,this.onClickCopyOverview,this.onClickRemoveAllHighlights,this.onClickRequestPermission,this.onClickReload])this.scope[t.name]=t.bind(this)}async init(){this.styleSheetManager.init();const t=await(new i).getAll(),e=await(new s).getAll(),a=e.sharedHighlightStyle;a&&this.styleSheetManager.setRule({className:this.styleSheetManager.sharedHighlightClassName,style:a},!1,t);const r=e.highlightDefinitions;if(r)for(let e of r)e={...e},delete e.no_user_select,this.styleSheetManager.setRule(e,!1,t);const c=await o.queryActiveTab();if(!c)throw new Error("no active tab");this.initialActiveTab=c,this.scope.highlightDefinitions=r,this.scope.popupHighlightTextMaxLength=5e3,this.scope.sort={value:t.highlight_sort_by,invert:t.highlight_invert_sort};try{this.scope.isPermissionGranted=await n.contains(n.DEFAULT_PERMISSIONS,n.getOrigins(c.url))}catch(t){this.scope.isPermissionGranted=!0}await new Promise((t=>{chrome.commands.getAll((e=>{this.scope.$apply((()=>{for(const t of e)this.scope.commands[t.name]=t})),t()}))})),this.scope.containsTTSPermission=await(async()=>{try{return await n.contains("tts")}catch{return!1}})(),this.scope.$watchCollection("sort",(async t=>{const e=new i;await e.set({highlight_sort_by:t.value,highlight_invert_sort:t.invert}),await this.updateDocs(),this.scope.isUpdated||(this.scope.isUpdated=!0,this.scope.isProgressVisible=!1),this.scope.$apply()})),this.scope.$apply(),new Promise((t=>setTimeout(t,500))).then((()=>{this.scope.isUpdated||(this.scope.isProgressVisible=!0,this.scope.progressStatus=chrome.i18n.getMessage("popup_status_init")),this.scope.$apply()})),document.querySelector("#input-search").focus(),document.querySelector("#btn-sort-invert").classList.add("button-animate-transition")}async updateDocs(){const t=await o.queryActiveTab();if(!t)throw new Error("no active tab");const e=c.formatMatch(t.url);let i=await this.db.getMatchingDocuments(e,{excludeDeletedDocs:!0});const n=new o(t.id);i=await Promise.all(i.map((async t=>{try{t.notInDOM=!await n.isHighlightInDOM(t._id)}catch{t.notInDOM=!0}return t}))),i=await c.sortDocuments(i,n.getComparisonFunction(this.scope.sort.value)),this.scope.sort.invert&&i.reverse();const a=(await(new s).getAll()).highlightDefinitions;for(const t of i){const e=t.className,i=a?.find((t=>t.className===e));t.noHighlightDefined=!Boolean(i),t.isBlockQuote=i?.blockquote??!1,a&&(t._textColorEqualsBackground=i?.text_color_equals_background??!1);let s,o=t.text;Object.hasOwn(t,"textLength")?(s=t.textLength,t.isTextTrimmed=!0):o?(s=o.length,o=o.substring(0,this.scope.popupHighlightTextMaxLength)):s=0,t.text=o??"",t._expandedTextLength=s}this.scope.docs=i;let r=[];switch(this.scope.sort.value){case"location":r.push({docs:i});break;case"time":for(const t of i){const e=new Date(t.date),i=Math.floor(e.getTime()/864e5);0!==r.length&&i===r[r.length-1].daysSinceEpoch||r.push({daysSinceEpoch:i,title:e.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),docs:[]}),r[r.length-1].docs.push(t)}break;case"style":const t=new Map(this.scope.highlightDefinitions.map(((t,e)=>[t.className,e])));let e=[];for(const s of i){const i=s.className,o=t.get(i);null!=o?(0!==r.length&&o===r[r.length-1]._definitionIndex||r.push({_definitionIndex:o,title:this.scope.highlightDefinitions[o].title,docs:[]}),r[r.length-1].docs.push(s)):e.push(s)}e.length>0&&r.push({title:chrome.i18n.getMessage("style_missing"),docs:e,style_missing:!0})}return this.scope.groupedDocs=r,i}onMouseEnterHighlight(t){const e=event.currentTarget;if(!e.classList.contains("highlight"))return;const i="ssh-close";let s=e.querySelector(`.${i}`);if(s){const t="timerId";s.dataset[t]&&(clearTimeout(parseInt(s.dataset[t])),delete s.dataset[t])}else s=document.createElement("button"),s.classList.add(i),s.addEventListener("click",this.onClickRemoveHighlight.bind(this,t),{passive:!0,capture:!0,once:!0}),e.appendChild(s)}onMouseLeaveHighlight(){const t=event.currentTarget;if(!t.classList.contains("highlight"))return;let e=t.querySelector(".ssh-close");if(!e)return;const i="timerId";e.dataset[i]=setTimeout((()=>{delete e.dataset[i],e.addEventListener("animationend",(t=>{e.remove()}),{once:!0,capture:!1,passive:!0}),e.style.animation=this.styleSheetManager.buttonPopOutAnimation}),p.#t).toString()}async onClickHighlightText(t){if(t.notInDOM)return;const e=await o.queryActiveTab();if(!e)throw new Error("no active tab");return await new o(e.id).scrollToHighlight(t._id)}async onClickTrimHighlight(t){const{ok:e,id:i,rev:s}=await this.db.trimDocumentText(t._id);if(!e)return;const o=await this.db.getDocument(i,{rev:s});t.text=o.text,t.isTextTrimmed=!0,t.expanded=!1,this.scope.$apply()}async onClickRemoveHighlight(t){event.stopPropagation();const e=await o.queryActiveTab();if(!e)throw new Error("no active tab");const i=new a(e.id),[s]=await i.delete(t._id);0!==((await s).some((({ok:t})=>t))?[]:await this.updateDocs()).length?this.scope.$apply():window.close()}async onClickExpandHighlight(t){event.preventDefault(),event.stopPropagation();const e=await this.db.getDocument(t._id);let i;const s=e.text;if(!e.notInDOM&&Object.hasOwn(e,"textLength")){const e=await o.queryActiveTab();if(!e)throw new Error("no active tab");const s=new o(e.id);i=await s.getHighlightText(t._id)}else i=s;i&&(document.querySelector(`#${t._id} .highlight-text-content`).innerText=i,t.expanded=!0,this.scope.$apply())}async onClickCopyHighlight(t){if("string"==typeof t.text)return navigator.clipboard.writeText(t.text)}async onClickSelectHighlight(t){if(t.notInDOM)throw new Error("not in DOM");const e=await o.queryActiveTab();if(!e)throw new Error("no active tab");const i=new o(e.id);await i.selectHighlight(t._id),await i.scrollToHighlight(t._id),window.close()}async onClickSpeakHighlight(t){if(!chrome.tts)return;const e=t.text;if("string"!=typeof e)return;const i=await o.queryActiveTab();if(!i)throw new Error("no active tab");const s=await new o(i.id).getNodeAttributeValue("/*","lang"),n="string"==typeof s?{lang:s}:{};chrome.tts.speak(e,n)}async onClickDefineHighlight(t,e){if(t.notInDOM)throw new Error("not in DOM");const i=await o.queryActiveTab();if(!i)throw new Error("no active tab");const s=new a(i.id);await s.update(t._id,e.className),t.className=e.className,"style"===this.scope.sort.value&&await this.updateDocs(),this.scope.$apply()}async onClickUndoLastHighlight(){const t=await o.queryActiveTab();if(!t)throw new Error("no active tab");const e=await l.onUndoCommand(t.id);!this.scope.needsReload&&e&&(this.scope.needsReload=!0),0!==(await this.updateDocs()).length?this.scope.$apply():window.close()}async onClickOpenOptionsPage(){chrome.runtime.openOptionsPage?await chrome.runtime.openOptionsPage():window.open(chrome.runtime.getURL("options.html"),"_blank"),window.close()}async onClickOpenOverview(){const t=await o.queryActiveTab();if(!t)throw new Error("no active tab");const e=g.getUrl([t.id],this.scope.sort.value,this.scope.sort.invert);await o.create({url:e}),window.close()}async onClickSaveOverview(){const t=await o.queryActiveTab();if(!t)throw new Error("no active tab");const e=await g.getFormattedText([t.id],this.scope.sort.value,this.scope.sort.invert,null,!1,"markdown",!0);if(!e)return;const i=document.createElement("a");i.download=chrome.i18n.getMessage("save_overview_file_name"),i.href=URL.createObjectURL(new Blob([e],{type:"text/markdown"}));try{const t=document.createEvent("MouseEvent");t.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(t)}finally{URL.revokeObjectURL(i.href)}}async onClickCopyOverview(){const t=await o.queryActiveTab();if(!t)throw new Error("no active tab");const e=await g.getFormattedText([t.id],this.scope.sort.value,this.scope.sort.invert,null,!1,"markdown",!1);if(e)return navigator.clipboard.writeText(e)}async onClickRemoveAllHighlights(){const t=await o.queryActiveTab();if(!t)throw new Error("no active tab");const e=c.formatMatch(t.url),i=new a(t.id);await i.deleteMatching(e),window.close()}async#i(){return o.queryActiveTab()}#s(t){if(0===t.length)return!1;const e=chrome.i18n.getMessage("alert_permission_request_failed",[t]);return window.alert(e),!0}async onClickRequestPermission(){const t=await this.#i();if(!t)throw new Error("no active tab");let e,i;try{i=await n.request(n.DEFAULT_PERMISSIONS,n.getOrigins(t.url)),i||(e=chrome.runtime.lastError?.message)}catch(t){i=!1,e=t.message}if(!i)return e&&this.#s(e),!1;const s=new o(t.id);await s.reload(),window.close()}async onClickReload(){const t=await o.queryActiveTab();if(!t)throw new Error("no active tab");const e=new o(t.id);await e.reload(),window.close()}}const d=new p(h);await d.init()}]);
