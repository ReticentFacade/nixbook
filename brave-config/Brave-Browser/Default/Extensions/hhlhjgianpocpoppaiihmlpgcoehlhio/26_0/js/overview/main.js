import"../chunks/Pk1FvCws.js";import{D as t,C as e,a as s,b as i}from"../chunks/CAmFpRSf.js";import{S as o}from"../chunks/CVw90xmA.js";import{U as a,P as n,D as l}from"../chunks/B3DQGssQ.js";import"../../static/js/pouchdb-8.0.1-supersimplehighlighter.min.js";angular.module("app",["controller","customFilters"]),angular.module("controller",[]).controller("overviewController",["$scope",async function(c){const{searchParams:r}=new URL(location.href);await new class{#t=null;get db(){return this.#t||(this.#t=new t),this.#t}constructor(t){this.scope=t,this.scope.manifest=chrome.runtime.getManifest(),this.scope.initProgress=0,this.scope.maxInitProgress=100,this.scope.links=[{href:a.createExtensionAssetURL(chrome.i18n.getMessage("help_pathname",["chrome"])),text:chrome.i18n.getMessage("help")}];for(const t of[this.onClickHighlight])this.scope[t.name]=t.bind(this)}async init(t){let a=t.has("q")?t.getAll("q").filter((t=>t.length>0)).map((t=>isNaN(t)?t:parseInt(t))):null;const c=t.get("sortby")??"location",r=Boolean(t.get("invert"));await n.serial(Object.entries({angular:"/static/css/angular-csp.css",bootstrap:"/static/css/bootstrap.min.css",overview:"/css/overview.css",dark:"/css/dark.css"}).map((([t,e])=>async()=>{if(document.querySelector(`style#${t}`))return;const s=document.createElement("style");s.id=t,document.head.appendChild(s);const i=await fetch(e);s.innerText=await i.text()})));const h=await(new e).getAll(),g=await(new s).getAll(),u=new o(document,"highlight","ssh-style");u.init();const p=g.sharedHighlightStyle;p&&u.setRule({className:"highlight",style:p},!1,h);const m=g.highlightDefinitions;if(m)for(let t of m)t={...t},delete t.blur,delete t.no_user_select,u.setRule(t,!0,h);u.textualizeStyleElement(),a||(this.scope.initStatus=chrome.i18n.getMessage("init_status_get_sums"),this.scope.$apply(),a=(await this.db.getSums()).filter((({value:t})=>t>0)).map((({key:t})=>t)));const d=[];this.scope.initProgress=a.length,this.scope.maxInitProgress=2*a.length,this.scope.initStatus=chrome.i18n.getMessage("init_status_get_matching"),this.scope.$apply();for(const[t,e]of a.entries()){const s={tabIdOrUrl:e};let o;if(isNaN(e))s.url=e,o=null;else{o=new i(e);const t=await o.get();s.url=t.url,s.title=t.title}const n=l.formatMatch(s.url);let h=await this.db.getMatchingDocuments(n,{excludeDeletedDocs:!0});if(this.scope.initProgress=a.length+t,this.scope.$apply(),!s.title&&(s.title=h.find((({title:t})=>t))?.title,!s.title)){const t=await this.db.getFirstDocuments([n],{includeDocKeys:"title"});t.length>0&&(s.title=t[0].title),s.title||(s.title=chrome.i18n.getMessage("untitled_page_title"))}if(o){await Promise.all(h.map((async t=>{t._isInDOM=await o.isHighlightInDOM(t._id)})));for(const t of h){if(void 0===t.textLength)continue;const e=await o.getHighlightText(t._id),s=t.text?.length??0;e&&e.length>s&&(t.text=e)}}const g=o?.getComparisonFunction(c);if(g&&(h=await l.sortDocuments(h,g)),r&&h.reverse(),m)for(const t of h){const e=t.className;t._textColorEqualsBackground=m.find((({className:t})=>t===e))?.text_color_equals_background??!1}s.firstDocs=h;let u=[];switch(c){case"location":u.push({docs:h});break;case"time":for(const t of s.firstDocs){const e=new Date(t.date),s=Math.floor(e.getTime()/864e5);0!==u.length&&s===u[u.length-1].daysSinceEpoch||u.push({daysSinceEpoch:s,title:e.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),docs:[]}),u[u.length-1].docs.push(t)}break;case"style":const t=new Map(m.map((({className:t},e)=>[t,e])));let e=[];for(const i of s.firstDocs){const s=i.className,o=t.get(s);null!=o?(0!==u.length&&o===u[u.length-1]._definitionIndex||u.push({_definitionIndex:o,title:m[o].title,docs:[]}),u[u.length-1].docs.push(i)):e.push(i)}e.length>0&&u.push({title:chrome.i18n.getMessage("style_missing"),docs:e,style_missing:!0})}s.groups=u,d.push(s)}const f=t.get("groupby");if(f){let e;switch(f){case"title":e=({title:t},{title:e})=>(t??"").localeCompare(e??"");break;case"first_date":e=({firstDocs:t},{firstDocs:e})=>t[0]?.date-e[0]?.date;break;case"last_date":const t=await this.db.getLastDocumentDates();e=({firstDocs:e},{firstDocs:s})=>{const i=e[0]?.match,o=s[0]?.match;return(t.get(i)??0)-(t.get(o)??0)};break;case"highlights_count":e=({firstDocs:t},{firstDocs:e})=>t.length-e.length}d.sort(e),Boolean(t.get("groupby_invert"))&&d.reverse()}this.scope.pages=d,this.scope.initProgress=this.scope.maxInitProgress,this.scope.$apply()}async onClickHighlight(t,{_id:e}){let s;if("number"==typeof t.tabIdOrUrl)s=t.tabIdOrUrl;else{const e="string"==typeof t.tabIdOrUrl?t.tabIdOrUrl:t.url,o=(await i.query({url:encodeURI(e),status:"complete"})).map((t=>t.id)).filter((t=>t!==chrome.tabs.TAB_ID_NONE));s=0===o.length?null:o[0]}if(s){const t=new i(s);try{if(await t.scrollToHighlight(e))return chrome.tabs.update(t.tabId,{active:!0})}catch(t){}}if(t.url)return i.create({url:t.url})}}(c).init(r)}]);
