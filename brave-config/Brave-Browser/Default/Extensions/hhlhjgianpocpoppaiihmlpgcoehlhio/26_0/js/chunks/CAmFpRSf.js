import{S as e,D as t,P as a}from"./B3DQGssQ.js";import"../../static/js/pouchdb-8.0.1-supersimplehighlighter.min.js";class r{static#e={unselectAfterHighlight:!1,allowNestedHighlights:!0,highlightBoxShadowEnabled:!1,highlight_sort_by:"time",highlight_invert_sort:!1,options_bookmarks_group_by:"title",options_bookmarks_ascending_order:!0};#t=null;#a=null;constructor(e="sync"){this.#t=e.toLowerCase(),this.#a=chrome.storage?.[e]}static getDefaults(){return r.#e}static getDefaultValue(e){return r.#e[e]}async get(e){const t=typeof e;if("string"===t&&(e=[e]),Array.isArray(e)){const t={};for(const a of e)t[a]=r.getDefaultValue(a);e=t}let a;return a=await this.#a.get(e),"string"===t?a[Object.getOwnPropertyNames(e)[0]]:a}async set(e,t){return"string"==typeof t&&(e={[t]:e}),this.#a.set(e)}async getAll(){return this.get(r.getDefaults())}async remove(e){return this.#a.remove(e)}async clear(){return this.#a.clear()}}var i={sharedHighlightStyle:{},highlightDefinitions:[{title:"Red",className:"default-red-aa94e3d5-ab2f-4205-b74e-18ce31c7c0ce",style:{"background-color":"#fecaca",color:"#7f1d1d"},default:!0},{title:"Orange",className:"default-orange-da01945e-1964-4d27-8a6c-3331e1fe7f14",style:{"background-color":"#fed7aa",color:"#7c2d12"}},{title:"Yellow",className:"default-yellow-aaddcf5c-0e41-4f83-8a64-58c91f7c6250",style:{"background-color":"#fef08a",color:"#713f12"}},{title:"Green",className:"default-green-c4d41e0a-e40f-4c3f-91ad-2d66481614c2",style:{"background-color":"#bbf7d0",color:"#14532d"}},{title:"Cyan",className:"default-cyan-f88e8827-e652-4d79-a9d9-f6c8b8ec9e2b",style:{"background-color":"#a5f3fc",color:"#164e63"}},{title:"Purple",className:"default-purple-c472dcdb-f2b8-41ab-bb1e-2fb293df172a",style:{"background-color":"#e9d5ff",color:"#581c87"}},{title:"Grey",className:"default-grey-da7cb902-89c6-46fe-b0e7-d3b35aaf237a",style:{"background-color":"#e5e7eb",color:"#111827"}},{title:"Redact",className:"c0df1986-e8fb-4981-8924-ba8c207c8041",text_color_equals_background:!0,style:{"background-color":"#404040"},no_user_select:!0},{title:"Red Text",className:"a60a98d6-946d-46a9-9044-9a97db57c7d1",inherit_style_background_color:!0,style:{color:"#dc2626"},hidden:!0},{title:"Bold",className:"ad1b8cd8-ab73-47dd-97a7-8344bf6db723",inherit_style_color:!0,inherit_style_background_color:!0,bold:!0},{title:"Italic",className:"df4a0c7b-c9e2-4583-b09e-8eb4c71382a1",inherit_style_color:!0,inherit_style_background_color:!0,italic:!0,hidden:!0},{title:"Underline",className:"c5b8582a-b9d7-421f-b027-1587b1f5367e",inherit_style_color:!0,inherit_style_background_color:!0,underline:!0,hidden:!0},{title:"Strikethrough",className:"def33222-aa74-4df1-894a-59a882dd26fb",inherit_style_color:!0,inherit_style_background_color:!0,strikethrough:!0},{title:"Fixed-width",className:"c6bab7ff-c90f-4f0f-8a44-51c32015d7bc",inherit_style_color:!0,inherit_style_background_color:!0,monospace:!0,hidden:!0},{title:"Blur",className:"a1b2b84c-1c56-44d3-aed1-b2137617587f",inherit_style_color:!0,inherit_style_background_color:!0,blur:1,hidden:!0},{title:"Magnify",className:"a2fd0e9f-02a3-496e-9f87-cd8ec0bd1edb",inherit_style_color:!0,inherit_style_background_color:!0,scale:2},{title:"Quotation",className:"ab9cf480-775e-436a-ad0a-08f8ba0d2136",style:{"background-color":"#f5f5f4",color:"#57534e"},blockquote:!0}]};class s{static#e={inherit_style_color:!1,inherit_style_background_color:!1,text_color_equals_background:!1,style:{"background-color":"#ffff00",color:"#000000"},drop_shadow:!1,blur:0,invert:!1,no_user_select:!1,bold:!1,italic:!1,underline:!1,strikethrough:!1,monospace:!1,blockquote:!1,scale:1,hidden:!1,default:!1};static getDefaults(){return s.#e}static getDefaultValue(e){return s.#e[e]}static createObject(t,{className:a=e.newRandomID({beginWithLetter:!0,length:16}),inheritStyleColor:r=s.getDefaultValue("inherit_style_color"),inheritStyleBackgroundColor:i=s.getDefaultValue("inherit_style_background_color"),textColorEqualsBackground:n=s.getDefaultValue("text_color_equals_background"),backgroundColor:o=s.getDefaultValue("style")["background-color"],color:c=s.getDefaultValue("style").color,dropShadow:l=s.getDefaultValue("drop_shadow"),blur:u=s.getDefaultValue("blur"),invert:h=s.getDefaultValue("invert"),noUserSelect:d=s.getDefaultValue("no_user_select"),bold:g=s.getDefaultValue("bold"),italic:m=s.getDefaultValue("italic"),underline:f=s.getDefaultValue("underline"),strikethrough:w=s.getDefaultValue("strikethrough"),monospace:b=s.getDefaultValue("monospace"),scale:y=s.getDefaultValue("scale"),blockquote:p=s.getDefaultValue("blockquote"),hidden:_=s.getDefaultValue("hidden")}={}){return{title:t,className:a,inherit_style_color:r,inherit_style_background_color:i,text_color_equals_background:n,style:{"background-color":o,color:c},drop_shadow:l,blur:u,invert:h,no_user_select:d,bold:g,italic:m,underline:f,strikethrough:w,monospace:b,scale:y,blockquote:p,hidden:_}}}class n extends r{static AREA_NAME="local";constructor(){super(n.AREA_NAME)}async getAll(){let e={};e.sharedHighlightStyle=i.sharedHighlightStyle??{};const t=s.getDefaults();return e.highlightDefinitions=(i.highlightDefinitions??[]).map((e=>{const a={...t,...e};return a.style={...t.style,...a.style},a})),super.get(e)}async setAll(e){const t=["highlightDefinitions","sharedHighlightStyle"],a=new Set(t.filter((t=>!e[t]))),r={};for(const a of t.filter((t=>e[t])))r[a]=e[a];return Promise.all([super.set(r),super.remove(Array.from(a))])}async set(e){Array.isArray(e)||(e=[e]);const{highlightDefinitions:t}=await this.getAll();for(const a of e){const e=t.findIndex((({className:e})=>e===a.className));t.splice(-1===e?t.length:e,-1===e?0:1,a)}return super.set(t,"highlightDefinitions")}async remove(e){const{highlightDefinitions:t}=await this.getAll(),a=t.findIndex((({className:t})=>t===e));if(-1!==a)return t.splice(a,1),super.set(t,"highlightDefinitions")}async removeAll(){return super.remove("highlightDefinitions")}}class o{#r=null;static get#i(){return"function"==typeof PouchDB}get#s(){return null!=this.#r}get pouchDB(){return this.#s||(this.#r=o.#n()),this.#r}static#n(){if(!o.#i)throw new Error("PouchDB not available");return new PouchDB("sos",{auto_compaction:!0,adapter:"idb",revs_limit:10})}async destroyDB(e=!1){await this.pouchDB.destroy(),this.#r=null,e&&this.pouchDB}async#o(e,{id:t,rev:a}={},r={}){if(t||a){const r=Object.assign({},e,t?{_id:t}:{},a?{_rev:a}:{});if(!r._id)throw new Error("undefined document id");e=r}else if(!e._id)throw new Error("undefined document id");return this.pouchDB.put(e,r)}async#c(e,t={}){return this.pouchDB.post(e,t)}async#l(e,t){return this.pouchDB.bulkDocs(e,t)}async removeDB(e,t,a){return this.pouchDB.remove(e,t,a)}async diagnoseDB(){let t=await this.infoDB(),a=await this.#u(!0);const r=new RegExp("^_design/");a.rows=a.rows.filter((({id:e})=>!e.match(r)));const i=new Map;for(const{doc:t}of a.rows){if(t.text&&(t.text=`[-${t.text.length}-]`),t.title&&(t.title=`[-${t.title.length}-]`),t.match){let a=i.get(t.match);a||(a=e.newRandomID({length:36}),i.set(t.match,a)),t.match=a}if(t.range){const{startContainerPath:e,endContainerPath:a}=t.range;e&&(t.range.startContainerPath=`[-${e.length}-]`),a&&(t.range.endContainerPath=`[-${a.length}-]`)}}return{info:t,docs:a}}async infoDB(){return this.pouchDB.info()}async compactDB(){return await this.pouchDB.compact()}async cleanupViews(){return this.pouchDB.viewCleanup()}async fixupIfRequired(){const e="__fixup_version",t=(await chrome.storage.local.get(e))[e]??0;try{await this.#h(t)}catch(e){}const a=parseInt(chrome.runtime.getManifest().version);t!=a&&await chrome.storage.local.set({[e]:a})}async#h(e){return e<18&&(await this.removeInvalidDeleteDocuments(),!0)}async removeInvalidDeleteDocuments(){const e="_fixup_invalid_delete_docs",t=`_design/${e}`;let a;try{a=(await this.pouchDB.get(t))._rev}catch(r){const i=await this.pouchDB.put({_id:t,views:{[e]:{map:"9fc40d0b-dab4-4859-b129-d62c0fcc70cb",reduce:"_count"}}});if(!i.ok)throw new Error("unable to put design document");a=i.rev}try{const t=new Set((await this.#d(e,{group:!0,group_level:1})).rows.filter((({value:e})=>e>1)).map((({key:e})=>e)));if(0===t.size)return[];const a=(await this.#d(e,{reduce:!1,include_docs:!0,keys:Array.from(t)})).rows,r=new Set(a.filter(((e,t,a)=>a.findIndex((({key:t})=>t===e.key))==t))),i=a.filter((e=>!r.has(e))).map((({doc:e})=>e));for(const e of i)e._deleted=!0;return await this.#l(i)}finally{await this.removeDB(t,a),await this.cleanupViews()}}async ensureDesignDocuments(e=!1){return Promise.allSettled([this.#g("my_index",{match_date_view:{map:"05683f7c-82b9-453a-b225-ee2b4344240a"},sum_view:{map:"209fea61-33e4-4bb9-9c8f-5a1ea0d4aea1",reduce:"_sum"}},"auto"===e||e),this.#g(null,{first_match:{map:"7549fdb5-f25b-4c3e-9867-3ff902193496"}},"auto"!==e&&e)])}async#g(e,t,a){e||(e=Object.keys(t)[0]);const r=`_design/${e}`;try{await this.pouchDB.get(r)}catch(e){await this.pouchDB.put({_id:r,views:t})}if(a)for(const a of Object.keys(t))this.#d(`${e}/${a}`,{limit:0})}async putCreateDocument(t,a,r,i,s,n,o,c={}){const l={verb:"create",match:t,date:o,range:a,className:r,text:i,v:chrome.runtime.getManifest().version};return"boolean"==typeof s&&(l.first=!0),"string"==typeof n&&(l.title=n),this.#o(l,{id:e.newRandomID({length:32})},c)}async updateCreateDocument(e,t={},a={abortSignal:null,rev:null}){const r=await this.getDocument(e,{..."string"==typeof a.rev?{rev:a.rev}:{}});return this.updateDocument(r,t,a)}async trimDocumentText(e,t={}){const a=await this.getDocument(e);if("create"!==a.verb)throw new Error("requires create document");if(Object.hasOwn(a,"textLength"))return{ok:!0,id:a._id,rev:a._rev};const r=a.text,i=r?.length??0;return i<=5e3?{ok:!1,id:a._id,rev:a._rev}:(a.text=r.substring(0,5e3),a.textLength=i,this.#o(a,{},t))}async updateDocument(e,{className:t,title:a,text:r}={},i={abortSignal:null}){if(!e._rev)throw new Error("missing revision id");if(i.abortSignal?.throwIfAborted(),"create"!==e.verb)throw new Error("incorrect verb");return t===e.className&&a===e.title&&r===e.text?{ok:!0,id:e._id,rev:e._rev}:(void 0!==t&&(e.className=t),void 0!==a&&(e.title=a),void 0!==r&&(e.text=r),this.#o(e,{},i))}async postDeleteDocument(e,{date:t=Date.now()}={},a={}){const r=await this.getDocument(e,{_exclude_doc_keys:"text"});if("create"!==r.verb)throw new Error("incorrect corresponding verb");const i={verb:"delete",match:r.match,date:t,correspondingDocumentId:e};return this.#c(i,a)}async getDocument(e,t={}){return this.pouchDB.get(e,t)}async removeMatchingDocuments(e,t={}){const a=await this.getMatchingDocuments(e,{includeDocKeys:["_id","_rev"]});return this.#l(a.map((({_id:e,_rev:t})=>({_id:e,_rev:t,_deleted:!0}))),t)}async cleanupDocuments(e={}){const t=await this.getSums();return Promise.all(t.filter((({value:e})=>e<=0)).map((({key:t})=>this.removeMatchingDocuments(t,e))))}async#d(e,t){return this.pouchDB.query(e,t)}async#u(e){const t={include_docs:e??!1};return this.pouchDB.allDocs(t)}async getMatchingSum(e){await this.ensureDesignDocuments(),await this.fixupIfRequired();const{rows:t}=await this.#d("my_index/sum_view",{key:e});return 0===t.length?0:t[0].value}async getSums(){await this.ensureDesignDocuments(),await this.fixupIfRequired();const{rows:e}=await this.#d("my_index/sum_view",{group:!0,group_level:1,include_docs:!1});return e}async getFirstDocuments(e,{excludeDocKeys:t,includeDocKeys:a,stale:r},i){await this.ensureDesignDocuments();const s={stale:r,_exclude_doc_keys:t,_include_doc_keys:a};let n=(await this.#d("first_match",{keys:e,include_docs:!0,...s})).rows.map((({doc:e})=>e));if(n.length===e.length)return n;const o=new Map(n.map((e=>[e.match,e]))),c=e.length;return n=await Promise.all(e.map((async(e,t)=>{const a=o.get(e);if(a)return a;const r=await this.getMatchingDocuments(e,{descending:!1,limit:1,...s});return i?.(t,c),1===r.length?r[0]:null}))),n}async getLastDocumentDates(){await this.ensureDesignDocuments(),await this.fixupIfRequired();const e=(await this.#d("my_index/match_date_view",{include_docs:!1})).rows,t=new Map;for(const a of e){const[e,r]=a.key,i=t.get(e);(!i||r>i)&&t.set(e,r)}return t}async getMatchingDocuments(e,{descending:t=!1,limit:a,verbs:r,excludeDeletedDocs:i,excludeDocKeys:s,includeDocKeys:n,stale:o,startDate:c,endDate:l={},inclusiveEnd:u=!0}={}){const h=void 0===c?[e]:[e,c],d=[e,l??{}],g={startkey:t?d:h,endkey:t?h:d,inclusive_end:u,descending:t,include_docs:!0};s&&(g._exclude_doc_keys=s),n&&(g._include_doc_keys=n),o&&(g.stale=o),"number"==typeof a&&(g.limit=a),await this.ensureDesignDocuments(),i||await this.fixupIfRequired();let m=(await this.#d("my_index/match_date_view",g)).rows.map((({doc:e})=>e));if(i){const e=new Set;for(const t of m)"delete"===t.verb&&(e.add(t.correspondingDocumentId),e.add(t._id));0!==e.size&&(m=m.filter((t=>!e.has(t._id))))}if(r){const e=new Set("string"==typeof r?[r]:r);m=m.filter((t=>e.has(t.verb)))}return m}static getActiveTasksList(){return PouchDB.activeTasks.list()}}class c{#m=void 0;constructor(e){this.#m=e}static addListeners(){chrome.action.onClicked.addListener((async e=>{const t=e.url??e.pendingUrl;await d.requestDefaults(t,e.id)}))}static async setDefaultGlobalPopup(){return chrome.action.setPopup({popup:"popup.html"})}static async getDefaultGlobalPopup(){return await chrome.action.getPopup({})}async setTitle(e){return chrome.action.setTitle({tabId:this.#m,title:e})}async setIcon(e){return chrome.action.setIcon({tabId:this.#m,...e})}async setBadgeText(e){return chrome.action.setBadgeText({tabId:this.#m,text:e??""})}async setEnabled(e){return e?chrome.action.enable(this.#m):chrome.action.disable(this.#m)}async setBadgeTextColor(e=null){}async setBadgeBackgroundColor(e=null){return browser.action.setBadgeBackgroundColor({tabId:this.#m,color:e})}}class l{#m=void 0;#f=null;get db(){return this.#f||(this.#f=new o),this.#f}constructor(e){this.#m=e}async create(e,t,a,r){if(e.collapsed)throw new Error("Collapsed range");const i=new g("number"==typeof this.#m&&this.#m||this.#m[0]),s=await this.db.getMatchingSum(t),n=s<=0?await i.get():null;delete e.collapsed;const o=s<=0||null;let l=n&&n.title!==n.url?n.title:null;const u=Date.now(),{id:h,rev:d}=await this.db.putCreateDocument(t,e,r,a,o,l,u);let m;try{m=await i.createHighlight(e,null,r,h)}catch(e){m=!1}if(!m)throw await this.db.removeDB(h,d),new Error("Error creating highlight in DOM - Removing associated document");const f=new c(i.tabId);await f.setEnabled(!0),await f.setBadgeText((s+1).toLocaleString())}async update(e,t){const{ok:a}=await this.db.updateCreateDocument(e,{className:t});if(!a)throw new Error("Response not OK");const r=new g("number"==typeof this.#m&&this.#m||this.#m[0]);if(!await r.updateHighlight(e,t))throw new Error("Error updating highlight in DOM")}static async canUpdate(e,t){const a=new n,{highlightDefinitions:r}=await a.getAll(),i=r.find((t=>t.className===e)),s=r.find((e=>e.className===t));return!(!i||!s)&&i.blockquote==s.blockquote}async delete(e,t={optimise:!1}){const a=await this.db.getDocument(e,{_exclude_doc_keys:"text"});let r;switch(a.verb){case"create":if(t.optimise&&(await this.db.getMatchingDocuments(a.match,{descending:!0,limit:1,verbs:"create",excludeDocKeys:"text"}))[0]._id===a._id){r=await this.db.removeDB(a._id,a._rev);break}r=await this.db.postDeleteDocument(e);break;case"delete":const i=(await this.db.getMatchingDocuments(a.match,{descending:!0,limit:1,verbs:"delete",excludeDocKeys:"text"}))[0];if(i._id!==a._id||i._rev!=a._rev)throw new Error("invalid document");r=await this.db.removeDB(a._id,a._rev);break;default:throw new Error("unknown verb")}if(!r?.ok)throw new Error("Error removing document",r);const i=await this.onDeleteDocument(a),s={needsReload:i.needsReload};return i.sum>0?[[],s]:[await this.db.removeMatchingDocuments(a.match),s]}async onDeleteDocument(e){let t,a="number"==typeof this.#m&&[this.#m]||this.#m;if(void 0===a&&(a=(await g.query({url:encodeURI(e.match),status:"complete"})).map((e=>e.id)).filter((e=>e!==chrome.tabs.TAB_ID_NONE))),"delete"!==e.verb)t=null;else{if(!e.correspondingDocumentId)throw new Error("no corresponding create doc id for delete doc");const a=await this.db.getDocument(e.correspondingDocumentId),r=await this.db.getMatchingDocuments(e.match,{descending:!0,verbs:"create",excludeDocKeys:"text",limit:1}),i=r.length>0&&r[0]._id===a._id;t=i?a:null}await Promise.all(a.map((async a=>{const r=new g(a);switch(e.verb){case"create":try{await r.removeHighlight(e._id)}catch(e){}break;case"delete":t&&await r.createHighlight(t);break;default:throw new Error("unknown verb "+e.verb)}})));const r=await this.db.getMatchingSum(e.match);await Promise.all(a.map((e=>new c(e))).map((async e=>{await e.setEnabled(r>0),await e.setBadgeText(r>0?r.toLocaleString():null)})));const i="delete"===e.verb&&!t;return{sum:r,needsReload:i}}async deleteMatching(e){const t=await this.db.removeMatchingDocuments(e),a="number"==typeof this.#m&&this.#m||this.#m[0],r=new c(a);await r.setEnabled(!1),await r.setBadgeText(null);const i=new g(a);await Promise.all(t.filter((e=>e.ok)).map((({id:e})=>i.removeHighlight(e))))}async undo(){const e=new g("number"==typeof this.#m&&this.#m||this.#m[0]),{url:a}=await e.get(),r=t.formatMatch(a),i=await this.db.getMatchingDocuments(r,{descending:!0,excludeDocKeys:"text",limit:1});if(i.length<1)throw new Error("No documents to undo.");const s=i[0];return this.delete(s._id)}}class u{static addListeners(){chrome.contextMenus.onClicked.addListener(u.#w)}static makeCreateHighlightMenuItemId(e){return`create_highlight.${"object"==typeof e&&e.className||e}`}static async createSelectionMenu(){const e={contexts:["selection"]},t="root";await u.#b(t);let[r]=await u.#y({...e,id:t,title:chrome.runtime.getManifest().name});const i=(await(new n).getAll()).highlightDefinitions.map(((e,t)=>[e,t])).sort((([e,t],[a,r])=>e.default?-1:a.default?1:t-r)).map((([e])=>e)).map(((e,t)=>[e,t])).filter((([e])=>!e.hidden)),s=i.map((([t,a],s)=>async function(){let n=i[s-1]?.[0];n?.default&&await u.#y({...e,parentId:r,id:"separator",type:"separator"});let o=t.title||`#${a+1}`;await u.#y({...e,id:u.makeCreateHighlightMenuItemId(t),parentId:r,title:o})}));await a.serial(s)}static async#b(e,{catchError:t=!1}={}){Array.isArray(e)||(e=[e]);const r=e.map((e=>function(){return new Promise(((a,r)=>{chrome.contextMenus.remove(e,(()=>{chrome.runtime.lastError&&t?r(new Error(chrome.runtime.lastError.message)):a(e)}))}))}));return a.serial(r)}static async#p(){return new Promise((e=>{chrome.contextMenus.removeAll((()=>{e()}))}))}static async#y(e){Array.isArray(e)||(e=[e]);const t=e.map((e=>function(){return new Promise(((t,a)=>{const r=chrome.contextMenus.create(e,(()=>{chrome.runtime.lastError?a(new Error(chrome.runtime.lastError.message)):t(r)}))}))}));return a.serial(t)}static async#w(e,a){const i=new RegExp("^(.+)\\.(.+)").exec(e.menuItemId);if(3===i?.length)switch(i[1]){case"create_highlight":const s=new g(a.id);if(e.editable){await s.windowAlert("alert_create_highlight_in_editable");break}if(e.frameUrl&&e.frameUrl!==a.url){await s.windowAlert("alert_create_highlight_in_subframe");break}if(!await d.requestDefaults(e.pageUrl,a.id,{forceExecuteScript:!0})){const e=chrome.runtime.lastError?.message;return void(e&&await s.windowAlert("alert_permission_request_failed",[e]))}const n=new l(a.id),c=i[2],u=new r,h=await u.get("allowNestedHighlights")?null:await s.getActiveHighlightID();let m;if(h){const e=new o,t=await e.getDocument(h,{_exclude_doc_keys:"text"});if(t.className===c)return;if(!await l.canUpdate(t.className,c))return;await n.update(h,c),m=!0}else{const a=await s.getSelectionRange();if(a?.collapsed??1)throw new Error("selection range not present or collapsed");await n.create(a,t.formatMatch(e.pageUrl,e.frameUrl),e.selectionText,c),m=await u.get("unselectAfterHighlight")}m&&await s.selectHighlight();break;default:throw new Error(`Unhandled menu item id: ${e.menuItemId}`)}}}class h{static#_=new Map;static setListener(){chrome.webNavigation.onCompleted.hasListener(h.#D)||chrome.webNavigation.onCompleted.addListener(h.#D)}static async#D(e){const{tabId:t}=e;if(0!==e.frameId)return;const a="AbortError";h.#_.get(t)?.abort(new DOMException(`Aborting onCompleted handler whilst in-flight (tabId=${t}, url=${e.url})`,a));const r=new AbortController;h.#_.set(t,r);try{await h.onCompleted(e,{abortSignal:r.signal})}catch(e){if(e instanceof DOMException&&e.name===a)return;if(e instanceof Error&&"Error"===e.name)return;throw e}finally{h.#_.delete(t)}}static async onCompleted({tabId:e,url:a},{abortSignal:r=null,forceExecuteScript:i=!1}={}){await c.getDefaultGlobalPopup()||await c.setDefaultGlobalPopup(),await u.createSelectionMenu();const s=t.formatMatch(a),n=new o,l=await n.getMatchingDocuments(s,{excludeDocKeys:"text"});r?.throwIfAborted();const h=new g(e);if(l.length>0){const e=l[0];if("create"===e.verb&&void 0===e.title){const{title:t,url:a}=await h.get();r?.throwIfAborted(),t!==a&&(await n.updateCreateDocument(e._id,{title:t},{abortSignal:r}),r?.throwIfAborted())}}const m=new c(e);if(await m.setEnabled(l.length>0),await m.setBadgeText(null),0===l.length&&!i)return;if(!await d.contains("scripting"))return void await m.setTitle(chrome.i18n.getMessage("page_action_title_permission_required"));if(!await h.executeDefaultScript())return;if(r?.aborted&&r?.throwIfAborted(),i&&0===l.length)return;const f=new Set,w=await h.playbackDocuments(l,(e=>{"create"===e.verb&&f.add(e._id)}),r);if(r?.throwIfAborted(),f.size>0){for(const e of l)"delete"===e.verb&&f.delete(e.correspondingDocumentId);f.size>0&&(await m.setTitle(chrome.i18n.getMessage("page_action_title_not_in_dom")),await m.setIcon({path:Object.fromEntries([16,19,24,32,38].map((e=>[e,`/static/images/action/warning/${e}.png`])))}))}const b=w+f.size;await m.setEnabled(b>0),await m.setBadgeText(b>0?b.toLocaleString():null)}}class d{static DEFAULT_PERMISSIONS=["webNavigation","scripting"];static getOrigins(e){const t=new URL(e);return t.pathname="*",t.username=t.password=t.search=t.hash="",[t.href]}static async contains(e,t=null){return chrome.permissions.contains(Object.assign({permissions:Array.isArray(e)?e:[e]},t?{origins:t}:{}))}static async request(e,t=null){return await chrome.permissions.request({permissions:Array.isArray(e)?e:[e],...Array.isArray(t)&&t.length>0?{origins:t}:{}})}static async requestDefaults(e,t,{forceExecuteScript:a=!1}={}){return!!await d.request(d.DEFAULT_PERMISSIONS,d.getOrigins(e))&&(d.DEFAULT_PERMISSIONS.includes("webNavigation")&&(h.setListener(),await h.onCompleted({tabId:t,url:e},{forceExecuteScript:a})),!0)}static async remove(e,t=null){return chrome.permissions.remove(Object.assign({permissions:Array.isArray(e)?e:[e]},t?{origins:t}:{}))}}class g{static#v=1e3;#m=void 0;get tabId(){return this.#m}constructor(e){this.#m=e}static async query(e={}){try{return chrome.tabs.query(e)}catch(e){throw new Error(chrome.runtime.lastError?.message)}}static async queryActiveTab(){const e=await g.query({active:!0,currentWindow:!0});return e.length>0?e[0]:null}async get(){try{return chrome.tabs.get(this.#m)}catch(e){throw new Error(chrome.runtime.lastError?.message)}}static async create(e){try{return chrome.tabs.create(e)}catch(e){throw new Error(chrome.runtime.lastError?.message)}}async reload(e){return chrome.tabs.reload(this.#m,e)}async executeDefaultScript(e={}){if(!await d.contains("scripting"))throw new Error("no scripting permission");const t=await chrome.scripting.executeScript({target:{tabId:this.#m},args:["/js/content_script/main.js"],func:async function(e){const{default:t}=await import(chrome.runtime.getURL(e));return await t()},...e});if(t.length<1)return!1;let a=t[0];if("object"==typeof a&&!Array.isArray(a)&&null!==a){if(a.error)throw a.error;a=a.result}if("boolean"==typeof a)return a;throw new Error("unhandled injection result from content script")}async#I(e=0){const t=new Promise(((e,t)=>{(async()=>{try{e(await g.#k(this.#m,{id:"ping"}))}catch(e){t(e)}})()}));if(0===e)return t;const a=new Promise(((t,a)=>setTimeout((()=>{a(new Error("Could not establish connection. Receiving end timeout."))}),e)));return Promise.race([t,a])}async sendMessage(e,t={},a={}){let r;try{r=await this.#I(g.#v)}catch(e){r=!1}return r||await this.executeDefaultScript(),g.#k(this.#m,{id:e,...t},a)}static async sendMessageAll(e,t={},a={}){let r=await g.query({status:"complete"});return r=r.filter((({url:e})=>e)),0===r.length?[]:(t={id:e,...t},Promise.allSettled(r.map((e=>g.#k(e.id,t,a)))))}static async#k(e,t,a={}){return chrome.tabs.sendMessage(e,t,a)}async createHighlight(e,t={},a,r,i){let s;return s=arguments.length<=2?g.#x(e):g.#M({range:e,className:a,highlightId:r,version:i||chrome.runtime.getManifest().version}),this.sendMessage("create_highlight",s,t)}async updateHighlight(e,t,a){return this.sendMessage("update_highlight",{highlightId:e,className:t},a)}async removeHighlight(e,t){return"string"==typeof e?this.sendMessage("remove_highlight",g.#E(e),t):this.sendMessage("remove_highlight",g.#B(e),t)}static#M({range:e,className:t,highlightId:a,version:r}){return{range:e,className:t,highlightId:a,version:r}}static#x(e){if("create"!==e.verb)throw new Error("invalid verb");return g.#M({range:e.range,className:e.className,highlightId:e._id,version:e.v||3})}static#E(e){return{highlightId:e}}static#B(e){if("delete"!==e.verb)throw new Error("invalid verb");return g.#E(e.correspondingDocumentId)}async windowAlert(e,t,a){return this.sendMessage("window_alert",{messageName:e,substitutions:t,options:a})}async getSelectionRange(e){return this.sendMessage("get_selection_range")}async getRangeText(e){return this.sendMessage("get_range_text",{range:e})}async getHighlightText(e){return this.sendMessage("get_highlight_text",{highlightId:e})}async selectHighlight(e){const t={};return e&&(t.highlightId=e),this.sendMessage("select_highlight",t)}async selectRange(e){const t={};return e&&(t.range=e),this.sendMessage("select_range",t)}async isHighlightInDOM(e){return this.sendMessage("is_highlight_in_dom",{highlightId:e})}async scrollToHighlight(e){return this.sendMessage("scroll_to_highlight",{highlightId:e})}async getNodeAttributeValue(e,t){return this.sendMessage("get_node_attribute_value",{xpathExpression:e,attributeName:t})}async getHighlightOffset(e){return this.sendMessage("get_highlight_offset",{highlightId:e})}async getHoveredHighlightID(){return this.sendMessage("get_hovered_highlight_id")}async getActiveHighlightID(){return this.sendMessage("get_active_highlight_id")}async playbackDocuments(e,t=null,a=null){return this.#A(e,t,a)}async#S(e,t,r){const i=await a.serial(e.map((e=>async()=>{let a;switch(r?.throwIfAborted(),e.verb){case"create":a=this.createHighlight(e);break;case"delete":a=this.removeHighlight(e);break;default:a=Promise.resolve(!1)}const i=await a;return r?.throwIfAborted(),i||t?.(e),i})));return r?.throwIfAborted(),i.length===e.length&&(e=Array.from(i.entries()).filter((([,e])=>e)).map((([t])=>e[t]))),g.#N(e)}async#A(e,t,a){const r=e.map((e=>{let t;switch(e.verb){case"create":t={id:"create_highlight",...g.#x(e)};break;case"delete":t={id:"remove_highlight",...g.#B(e)};break;default:return null}return t})).filter((e=>e));a?.throwIfAborted();const i=await this.sendMessage("execute_compound_message",{messages:r});if(a?.throwIfAborted(),i?.length==e.length){if(t)for(const[a,r]of i.entries())r||t(e[a]);e=Array.from(i.entries()).filter((([,e])=>e)).map((([t])=>e[t]))}return g.#N(e)}static#N(e){return e.map((({verb:e})=>{switch(e){case"create":return 1;case"delete":return-1;default:return 0}})).reduce(((e,t)=>e+t),0)}getComparisonFunction(e){switch(e){case"time":return async e=>{e.date};case"location":return async e=>{if(!await this.isHighlightInDOM(e._id))throw new Error;const{top:t}=await this.getHighlightOffset(e._id);return t};case"style":let e=new Map;const t=new n;return async a=>{if(0===e.size){const a=await t.getAll();for(const[t,{className:r}]of a.highlightDefinitions.entries())e.set(r,t)}return e.get(a.className)};default:throw"Unknown type"}}}export{r as C,o as D,l as H,n as a,g as b,d as c,s as d,h as e,c as f,u as g};
