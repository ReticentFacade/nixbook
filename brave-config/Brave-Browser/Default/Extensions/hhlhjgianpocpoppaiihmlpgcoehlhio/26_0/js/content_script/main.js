import{S as e}from"../chunks/CVw90xmA.js";import{S as t,a as n,R as i,O as s}from"../chunks/B3DQGssQ.js";import{C as a}from"../chunks/cMonL6jB.js";class r{static#e=new Set(["TABLE","TR","COL","COLGROUP","THEAD","TBODY","TFOOT"]);static#t=new Set(["SCRIPT","NOSCRIPT","STYLE","SELECT"]);#n=null;constructor(e){this.#n=e}mark(e,n,i,s=!0){const a=this.#n.createElement(n);if(s)try{return e.surroundContents(a),i&&(a.id=i),a.dataset.sshpid=t.newRandomID(),[a]}catch{}const r=[];return this.#i(e,r,(()=>{const e=a.cloneNode(!1),n=r.length;return 0===n&&i&&(e.id=i),e.dataset.sshpid=t.newRandomID(),n>0&&(e.dataset.sshfmid=r[0].id,r[n-1].dataset.sshnpid=e.dataset.sshpid,r[n-1].sshnpid=e),r.push(e),e})),r}#i(e,t,n){if(e.collapsed)return;let i=e.startContainer,s=e.endContainer,a=!0;if(0===e.endOffset){for(;!s.previousSibling&&s.parentNode!==e.commonAncestorContainer;)s=s.parentNode;s=s.previousSibling}else s.nodeType===Node.TEXT_NODE?e.endOffset<s.nodeValue.length&&s.splitText(e.endOffset):e.endOffset>0&&(s=s.childNodes.item(e.endOffset-1));i.nodeType===Node.TEXT_NODE?e.startOffset===i.nodeValue.length?a=!1:e.startOffset>0&&(i=i.splitText(e.startOffset),s===i.previousSibling&&(s=i)):e.startOffset<i.childNodes.length?i=i.childNodes.item(e.startOffset):a=!1,e.setStart(e.startContainer,0),e.setEnd(e.startContainer,0);for(let e=!1,o=i;!1===e;){if(a&&o.nodeType===Node.TEXT_NODE&&(!o.parentNode||!r.#e.has(o.parentNode.nodeName))){let e=o.previousSibling;e&&0!=t.length&&e===t[t.length-1]||(e=n(),o.parentNode.insertBefore(e,o)),e.appendChild(o),o=e.lastChild,a=!1}o!==s||a&&s.hasChildNodes()||(e=!0),r.#t.has(o.nodeName)&&(a=!1),a&&o.hasChildNodes()?o=o.firstChild:o.nextSibling?(o=o.nextSibling,a=!0):o.nextSibling||(o=o.parentNode,a=!1)}}markBlock(e,n){const i=this.#n.createElement("MARK");return i.appendChild(e.extractContents()),e.insertNode(i),n&&(i.id=n),i.dataset.sshpid=t.newRandomID(),i}unmark(e){let t=this.getMarkElements(e);for(const e of t){for(;e.hasChildNodes();){const t=e.parentNode.insertBefore(e.firstChild,e);t.nodeType===Node.TEXT_NODE&&this.#s(t)}const t=e.previousSibling;e.parentNode.removeChild(e),t&&t.nodeType===Node.TEXT_NODE&&this.#s(t)}return t}#s(e){e.nextSibling&&e.nextSibling.nodeType===Node.TEXT_NODE&&(e.textContent+=e.nextSibling.textContent,e.nextSibling.parentNode.removeChild(e.nextSibling)),e.previousSibling&&e.previousSibling.nodeType===Node.TEXT_NODE&&(e.previousSibling.textContent+=e.textContent,e.parentNode.removeChild(e))}update(e,t,n=[]){const i=new Set(Array.isArray(n)?n:[n]),s=this.getMarkElements(e);for(const{classList:e}of s)e.remove(...Array.from(e).filter((e=>!i.has(e)))),e.add(t);return s}getFirstMarkElement(e){let t;if("string"==typeof e){if(t=this.#n.getElementById(e),!t){const i=this.#n.querySelector(`mark[data-${n.camelCaseToHyphen("sshpid")}="${e}"][data-${n.camelCaseToHyphen("sshfmid")}]`);i&&(t=this.#n.getElementById(i.dataset.sshfmid))}}else if(e instanceof HTMLElement){const n=e.id||e.dataset.sshfmid;t=n&&this.#n.getElementById(n)||null}else t=null;return"MARK"!=t?.tagName?null:t}getMarkElements(e){const t=this.getFirstMarkElement(e);if(!t)return[];let i=[t];const s=n.camelCaseToHyphen("sshpid");for(;;){let e=i[i.length-1].sshnpid;if(!e){const t=i[i.length-1].dataset.sshnpid;if(!t)break;if(e=this.#n.querySelector(`mark[data-${s}="${t}"]`),!e)break}i.push(e)}return i}getRange(e){const t=this.getMarkElements(e),n=this.#n.createRange();for(const e of t)n.collapsed&&n.setStartBefore(e),n.setEndAfter(e);return n}}class o{static#a=350;static#r=750;#o=null;#h=null;#l=void 0;#n=void 0;static#g=!1;constructor(e,t=window.document){this.#l=e,this.#n=t,this.#h=this.#d.bind(this),this.#o=new Map([["pointerenter",this.#c.bind(this)],["pointerleave",this.#u.bind(this)],["focusin",this.#m.bind(this)],["focusout",this.#E.bind(this)]])}addHighlightEventListeners(e){for(const[t,n]of this.#o)e.addEventListener(t,n,{capture:o.#g,passive:!0})}removeHighlightEventListeners(e){for(const[t,n]of this.#o)e.removeEventListener(t,n,{capture:o.#g})}#p(e){return e instanceof HTMLElement&&"MARK"===e.tagName&&e.classList.contains(this.#l.sharedHighlightClassName)}#c({target:e}){if(!this.#p(e))return;const t=new r(this.#n).getFirstMarkElement(e);if(!t)return;let n=t.querySelector(":scope > .ssh-close");n?n.dataset.timer_id_leave&&(clearTimeout(parseInt(n.dataset.timer_id_leave)),delete n.dataset.timer_id_leave):(n=this.#n.createElement("button"),n.type="button",n.tabIndex=-1,n.classList.add("ssh-close"),n.dataset[h.DataAttributeName.FOREIGN]="",n.addEventListener("click",this.#f,{passive:!0,capture:!0,once:!0}),t.dataset.timer_id_enter=setTimeout(((e,t)=>{delete e.dataset.timer_id_enter,e.prepend(t)}),o.#a,t,n).toString())}#u({target:e}){if(!this.#p(e))return;const t=new r(this.#n).getFirstMarkElement(e);if(!t)return;t.dataset.timer_id_enter&&(clearTimeout(parseInt(t.dataset.timer_id_enter)),delete t.dataset.timer_id_enter);const n=t.querySelector(":scope > .ssh-close");n&&(n.dataset.timer_id_leave=setTimeout((e=>{delete e.dataset.timer_id_leave,e.addEventListener("animationend",(function(){this.remove()}),{once:!0,capture:!1,passive:!0});const t=function(){e.style.animation=this.#l.buttonPopOutAnimation}.bind(this);this.#n.activeElement===e?e.addEventListener("focusout",t,{passive:!0,capture:!1,once:!0}):t()}),o.#r,n).toString())}#m({target:e}){this.#p(e)&&e.addEventListener("keydown",this.#h,{capture:!1,passive:!0})}#E({target:e}){this.#p(e)&&e.removeEventListener("keydown",this.#h,{capture:!1})}async#d(e){if(e.isComposing||"Backspace"!==e.key)return;e.stopPropagation();const t=new r(this.#n),n=t.getFirstMarkElement(e.target)?.id;return n?h.deleteHighlight(n):void 0}async#f(e){e.stopPropagation();const t=e.target.parentElement;if(!t?.id)throw new Error("unknown highlight id");return h.deleteHighlight(t.id)}}class h{static DataAttributeName={FOREIGN:"foreign"};#_=void 0;#l=void 0;#n=void 0;get#v(){return new Set([this.#l.sharedHighlightClassName])}#S=null;get#N(){return this.#S||(this.#S=new r(this.#n)),this.#S}#b=new Set;#k=new Set;constructor(e,t){this.#l=e,this.#n=t,this.#_=new o(e,t);const n=`.${this.#l.sharedHighlightClassName}`;this.#l.insertRule(`${n} { \n      position: relative !important;\n      border-radius: 0.2em !important;\n      text-shadow: none !important;\n      transition-property: background-color, color, filter, box-shadow !important;\n      transition-duration: 600ms !important;\n    \n      color: inherit;\n      background-color: inherit;\n      font: inherit;\n      filter: inherit;\n    }`),this.#l.insertRule(`${n}:focus:not(:focus-visible) {\n      outline: Highlight auto thin !important;\n      outline: -webkit-focus-ring-color auto thin !important;\n    }`)}async init(){chrome.runtime.onMessage.addListener(this.#H.bind(this));const e=await h.#y("highlightStorage"),t={sharedHighlightStyle:{newValue:e.sharedHighlightStyle},highlightDefinitions:{newValue:e.highlightDefinitions}};return await this.#T(t,"local"),this}#H(e,t,n){let s;switch(e.id){case"ping":s=!0;break;case"on_storage_changed":this.#T(e.changes,e.areaName),s=null;break;case"create_highlight":{let t;try{if(t=i.toRange(e.range,this.#n),!t)throw new Error("Unable to parse xrange")}catch(e){s=!1;break}s=this.#M(t,e.version,e.highlightId,e.className).length>0}break;case"update_highlight":s=this.#C(e.highlightId,e.className).length>0;break;case"remove_highlight":s=this.#w(e.highlightId).length>0;break;case"select_highlight":{const t=this.#O(e.highlightId);s=t?i.toObject(t):null}break;case"get_highlight_text":s=this.#R(e.highlightId)?.toString()??null;break;case"select_range":{const t=e.range?i.toRange(e.range,this.#n):null;this.#I(t),s=t?i.toObject(t):null}break;case"is_highlight_in_dom":s=this.#L(e.highlightId);break;case"get_selection_range":s=i.toObject(this.#A());break;case"get_range_text":s=i.toRange(e.range,this.#n)?.toString()??null;break;case"scroll_to_highlight":s=this.#x(e.highlightId);break;case"get_highlight_offset":{const t=this.#D(e.highlightId);s=t&&{left:t.left,top:t.top}||null}break;case"get_node_attribute_value":{const{singleNodeValue:t}=document.evaluate(e.xpathExpression,this.#n,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);s=t?.attributes?.[e.attributeName]??null}break;case"get_hovered_highlight_id":s=this.#B();break;case"get_active_highlight_id":s=this.#F();break;case"execute_compound_message":s=e.messages.map((e=>{let n;return this.#H(e,t,(e=>{n=e})),n}));break;case"window_alert":this.#V(e.messageName,e.substitutions,e.options),s=!0}return n(s),!1}async#T(e,t){if("local"!==t)return;const n=await h.#y("storage");if(e.sharedHighlightStyle){const t=this.#l.sharedHighlightClassName,i=e.sharedHighlightStyle;i.oldValue&&this.#l.deleteRule(t),i.newValue&&!s.isEmpty(i.newValue)&&this.#l.setRule({className:t,style:i.newValue},!1,n)}const i=()=>{this.#l.textualizeStyleElement()};if(e.highlightDefinitions){const t=e.highlightDefinitions;t.oldValue?.forEach((({blockquote:e,text_color_equals_background:t,className:n})=>{e&&this.#b.delete(n),t&&this.#k.delete(n)})),t.newValue?.forEach((({blockquote:e,text_color_equals_background:t,className:n})=>{e&&this.#b.add(n),t&&this.#k.add(n)})),setTimeout((()=>{t.oldValue?.forEach((({className:e})=>{this.#l.deleteRule(e)})),t.newValue?.forEach((e=>{this.#l.setRule(e,!0,n)})),i()}),25)}else i()}#M(e,t,n,i){let s;if(t>=15&&this.#b.has(i))s=[this.#N.markBlock(e,n)];else{const a=t>=4?"MARK":"SPAN",r=t>=16&&(t<23||!this.#k.has(i));if(s=this.#N.mark(e,a,n,r),0===s.length)return[]}for(const e of s)e.classList.add(...this.#v,i),e.tabIndex=0,this.#_.addHighlightEventListeners(e);return t<=3&&s[0].appendChild(document.createElement("span")),s}#C(e,t){return this.#N.update(e,t,Array.from(this.#v))}#w(e){const t=this.#N.getMarkElements(e);if(t.length>0){const e=`[${`data-${h.DataAttributeName.FOREIGN.replace(/[A-Z]/g,"-$&")}`.toLowerCase()}]`,n=t[0];for(const t of n.querySelectorAll(e))t.remove()}for(const e of t)this.#_.removeHighlightEventListeners(e);return this.#N.unmark(e)}#R(e){return this.#N.getRange(e)}#O(e){const t=e?this.#N.getRange(e):null;return this.#I(t),t||new Range}#I(e){const t=getSelection();t.removeAllRanges(),e&&t.addRange(e)}#A(){const e=this.#n.getSelection();if(!e.isCollapsed)return e.getRangeAt(0);const t=new Range;return t.collapse(!1),t}#x(e){const t=document.getElementById(e);if(!t)return!1;t.scrollIntoView({behavior:"smooth",block:"center"});const n=this.#N.getMarkElements(t),i=function(){this.style.animation=null};for(const e of n)e.style.animation=this.#l.highlightFlashAnimation,e.addEventListener("animationend",i,{once:!0,capture:!1,passive:!0});return!0}#D(e){return this.#n.getElementById(e)?.getBoundingClientRect()??null}#B(){const e=this.#n.querySelector(`.${this.#l.sharedHighlightClassName}:hover`);return e?this.#N.getFirstMarkElement(e)?.id??"":""}#F(){const e=this.#n.activeElement;return e?.classList.contains(this.#l.sharedHighlightClassName)?this.#N.getFirstMarkElement(e)?.id??"":""}#L(e){return this.#N.getFirstMarkElement(e)?.id===e}#V(e,t,n){if(!window.alert)return!1;const i=chrome.i18n.getMessage(e,t,n);if(!i)return!1;const s=chrome.i18n.getMessage("extension_name");return window.alert(chrome.i18n.getMessage("alert_content_script_format",[s,i])),!0}static async#y(e){return a.sendMessage({id:"__storage_get_all",storageName:e})}static async deleteHighlight(e){return a.sendMessage({id:"__delete_highlight",highlightId:e})}}async function l(){if(globalThis.contentScriptInitialized)return!1;globalThis.contentScriptInitialized=!0;const t=new e(document);t.init();const n=new h(t,document);return await n.init(),!0}export{l as default};
